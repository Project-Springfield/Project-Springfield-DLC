<ScriptPackage>
	<Scroll_Begin parallel="true" interruptable="true" ignoreHUD="true">
		<Action type="checkRequirements">
			<Requirement type="variable" variable="DroneScan_Active" />
			<True>
				<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="1" />
				<Action type="pantosequence" time="4" character="HiddenAgent|SuperAgent" maxSpeed="10" minSpeed="10" blockTouches="false" sort="true" clusterRadius="200" camAcceleration="7.5" zoom="0.2" inertiaSeekDistance="9999" />
				<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="0" />
			</True>
		</Action>
	</Scroll_Begin>
	<Scroll_Resume parallel="true" interruptable="true" ignoreHUD="true">
		<Action type="checkRequirements">
			<Requirement type="variable" variable="DroneScan_Active" />
			<True>
				<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="1" />
				<Action type="updateVariable" disableEvents="true" variable="DS_PAUSED" value="0" />
				<Action type="pantosequence" time="4" character="HiddenAgent|SuperAgent" maxSpeed="10" minSpeed="10" blockTouches="false" sort="true" clusterRadius="200" camAcceleration="7.5" zoom="0.2" inertiaSeekDistance="200" />
				<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="0" />
			</True>
		</Action>
	</Scroll_Resume>
	<StartDroneScan>
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:CleanUp" />
		<Action type="sound" sound="UIButton" />
		<Action type="returnToInGameState" waitForState="true" />
		<Action type="setMiniGameState" building="SurveillancePost" name="DroneScan" state="Playing" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_Active" value="1" />
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:PlayDroneGame" ignoreObject="true" />
		<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:DroneScanStart_Countdown" shouldSave="false" relativeTime="1s" />
		<Action type="toggleMonorail" stop="true" />
	</StartDroneScan>
	<DroneScanShader ignoreHUD="true">
		<Action type="setShader" shader="DroneScan" set="ShaderSets:InGameSetSansCharacters" />
	</DroneScanShader>
	<ConfirmQuit ignoreHUD="true">
		<Action type="if">
			<If expression="DroneScan_Active &amp;&amp; DS_PAUSED==0">
				<Then>
					<Action type="interruptScript">
						<Interrupt package="SecretAgents_Scripts_DroneScan" script="Scroll_Begin">
							<InCategory category="any" />
						</Interrupt>
					</Action>
					<Action type="interruptScript">
						<Interrupt package="SecretAgents_Scripts_DroneScan" script="Scroll_Resume">
							<InCategory category="any" />
						</Interrupt>
					</Action>
					<Action type="updateVariable" disableEvents="true" variable="DS_PAUSED" value="1" />
					<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="0" />
					<Action type="showMenu" menu="notificationimage2button" scriptResProvider="notificationimage2button.mns" menuConfig="SecretAgents_MenuConfig_DroneScan:DroneScanQuit_MenuConfig" buttonsConfig="SecretAgents_MenuConfig_DroneScan:DroneScanQuit_ButtonConfig" />
				</Then>
			</If>
		</Action>
	</ConfirmQuit>
	<EndGame ignoreHUD="true">
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_Active" value="0" />
		<Action type="scheduleScript" mode="delete" script="SecretAgents_Scripts_DroneScan:*" />
		<Action type="hudTip" clear="true" />
		<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:EndGame2" shouldSave="false" relativeTime="1.5s" />
	</EndGame>
	<EndGame2 ignoreHUD="true">
		<Action type="fadeScreen" colour="Black" direction="out" speed="2.0" />
		<Action type="hideAllCharacters" hide="false" />
		<Action type="hideAllFlyBys" hide="false" />
		<Action type="hideIndicators" hide="false" predicate="anyIndicator" />
		<Action type="gotoState" state="GameState_InGame" />
		<Action type="toggleMonorail" stop="false" />
		<Action type="pantoobject" building="SurveillancePost" time="0" />
		<Action type="delay" time="1" />
		<Action type="fadeScreen" colour="Black" direction="in" speed="2.0" />
		<Action type="program">
			<Program><![CDATA[
					#program;
					var param1 = Array::create('type'=>'Score', 'source'=>'StrictlyPositiveCounter', 'extra'=>1);

					var DNAArray = Array::create('id'=>3370, 'param1'=>param1);

					DNA::Add(DNAArray);

					var param1 = Array::create('type'=>'Score', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_PTEarned'));
					var param2 = Array::create('type'=>'Score', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_XPEarned'));
					var param3 = Array::create('type'=>'Score', 'source'=>'StrictlyPositiveCounter', 'extra'=>1);

					var DNAArray = Array::create('id'=>3373, 'param1'=>param1, 'param2'=>param2, 'param3'=>param3);

					DNA::Add(DNAArray);
				]]></Program>
		</Action>
		<Action type="if">
			<If>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActOne" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								var param1 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_PTEarned'));
								var param2 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_XPEarned'));
								var param3 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>1);

								var DNAArray = Array::create('id'=>3371, 'param1'=>param1, 'param2'=>param2, 'param3'=>param3);

								DNA::Add(DNAArray);
							]]></Program>
					</Action>
				</Then>
			</If>
			<ElseIf>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActTwo" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								var param1 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_PTEarned'));
								var param2 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_XPEarned'));
								var param3 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>2);

								var DNAArray = Array::create('id'=>3371, 'param1'=>param1, 'param2'=>param2, 'param3'=>param3);

								DNA::Add(DNAArray);
							]]></Program>
					</Action>
				</Then>
			</ElseIf>
			<ElseIf>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActThree" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								var param1 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_PTEarned'));
								var param2 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>User::getVariable('DroneScan_XPEarned'));
								var param3 = Array::create('type'=>'Enumeration', 'source'=>'StrictlyPositiveCounter', 'extra'=>3);

								var DNAArray = Array::create('id'=>3371, 'param1'=>param1, 'param2'=>param2, 'param3'=>param3);

								DNA::Add(DNAArray);
							]]></Program>
					</Action>
				</Then>
			</ElseIf>
		</Action>
		<Action type="logevent" eventId="8007" param1Type="Enumeration" param1="HiddenAgent" param2Type="Enumeration" param2AsFormula="DroneScan_HiddenAgentsTapped" param3Type="Enumeration" param3AsFormula="DroneScan_HiddenAgentsSpawned" />
		<Action type="logevent" eventId="8007" param1Type="Enumeration" param1="SuperAgent" param2Type="Enumeration" param2AsFormula="DroneScan_SuperAgentsTapped" param3Type="Enumeration" param3AsFormula="DroneScan_SuperAgentsSpawned" />
		<Action type="runScript" script="SecretAgents_Scripts_DroneScan:GiveRewardAndShowPanel" />
	</EndGame2>
	<PlayDroneGame ignoreHUD="true">
		<Action type="updateVariable" disableEvents="true" variable="ISPANNING" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DS_PAUSED" value="1" />
		<Action type="updateVariable" disableEvents="true" variable="DS_FRAMECNT" value="toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:ScanDuration_sec__'))" />
		<Action type="fadeScreen" colour="Black" direction="out" speed="2.0" />
		<Action type="pantoobject" building="SurveillancePost" time="0" />
		<Action type="sound" sound="DroneScan_Ambience_Loop" />
		<Action type="sound" sound="DroneScan_Start" />
		<Action type="hideAllCharacters" exceptCharacters="HiddenAgent|SuperAgent" hide="true" />
		<Action type="hideAllFlyBys" exceptFlyBys="BlastEffect" hide="true" />
		<Action type="hideIndicators" hide="true" predicate="anyIndicator" />
		<Action type="program">
			<Program><![CDATA[
                    #program;
                    var x = toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:StartingBank__'));
                    do
                    {
                    x = x-1;
                    Script::runImmediately('SecretAgents_Scripts_DroneScan:SpawnMore');
                    } while (x > 0);


					var hiddenAgent = Character::find('HiddenAgent');
					var hiddenAgentArray = Land::getAllInstancesOfObject(hiddenAgent);
					var superAgent = Character::find('SuperAgent');
					var superAgentArray = Land::getAllInstancesOfObject(superAgent);
					User::setVariable('DroneScan_HiddenAgentsSpawned', Array::size(hiddenAgentArray), false);
					User::setVariable('DroneScan_SuperAgentsSpawned', Array::size(superAgentArray), false);
				]]></Program>
		</Action>
		<Action type="customTouch">
			<Attribute name="allowCameraMovement" value="false" />
			<Attribute name="hideAllMenus" value="true" />
			<Attribute name="unloadScript" value="SecretAgents_Scripts_DroneScan:UnloadCustomTouch" />
			<Attribute name="config">
				<AttributeSet name="HiddenHUDElements">
					<Attribute name="BottomButtons" value="true" />
					<Attribute name="SpecialEventButtons" value="true" />
					<Attribute name="Sidebar" value="true" />
					<Attribute name="Taskbar" value="true" />
					<Attribute name="ShiftSpendable" value="true" />
					<Attribute name="Info" value="true" />
					<Attribute name="HUDCurrencies" value="true" />
				</AttributeSet>
				<AttributeSet name="menuConfig">
					<Attribute name="file" value="MinigameHUDDroneScan" />
					<Attribute name="config" value="MinigameHUDDroneScan.mns" />
					<Attribute name="hud">
						<AttributeSet name="onBackButton">
							<Attribute name="mapTo" value="ExitButton" />
						</AttributeSet>
						<AttributeSet name="Exitbutton">
							<Attribute name="visible" value="false" />
						</AttributeSet>
						<AttributeSet name="ExitbuttonHL">
							<Attribute name="visible" value="false" />
						</AttributeSet>
						<AttributeSet name="RandomTextAnim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Text" />
						</AttributeSet>
						<AttributeSet name="RandomGaugeRightAnim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Gauge01" />
						</AttributeSet>
						<AttributeSet name="RandomGaugeLeftAnim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Gauge02" />
						</AttributeSet>
						<AttributeSet name="ScanlineEffectAnim01">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Scanline" />
							<Attribute name="animation" value="scanline_slow" />
							<Attribute name="loop" value="true" />
						</AttributeSet>
						<AttributeSet name="ScanlineEffectAnim02">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Scanline" />
							<Attribute name="animation" value="scanline_fast" />
							<Attribute name="loop" value="true" />
						</AttributeSet>
						<AttributeSet name="Time01Anim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Countdown" />
							<Attribute name="animation" value="timer_0" />
							<Attribute name="loop" value="false" />
						</AttributeSet>
						<AttributeSet name="Time02Anim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Countdown" />
							<Attribute name="animation" value="timer_0" />
							<Attribute name="loop" value="false" />
						</AttributeSet>
						<AttributeSet name="TimeColonAnim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Countdown" />
							<Attribute name="animation" value="timer_static_colon" />
							<Attribute name="loop" value="false" />
						</AttributeSet>
						<AttributeSet name="Time03Anim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Countdown" />
							<Attribute name="loop" value="false" />
							<Attribute name="animation" value="timer_{0}" parameters="textParams">
								<AttributeSet name="textParams">
									<Attribute name="0" formula="floor(toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:ScanDuration_sec__'))/10)" />
								</AttributeSet>
							</Attribute>
						</AttributeSet>
						<AttributeSet name="Time04Anim">
							<Attribute name="image" value="ICO_SecretAgents_DroneScan_Countdown" />
							<Attribute name="loop" value="false" />
							<Attribute name="animation" value="timer_{0}" parameters="textParams">
								<AttributeSet name="textParams">
									<Attribute name="0" formula="mod(toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:ScanDuration_sec__')),10)" />
								</AttributeSet>
							</Attribute>
						</AttributeSet>
						<AttributeSet name="BattleIntroAnim">
							<Attribute name="image" value="ICO_SecretAgents_BattleIntro" />
							<Attribute name="visible" value="false" />
						</AttributeSet>
						<AttributeSet name="RightCounter">
							<Attribute name="text" value="0" />
							<Attribute name="font" value="eFont_LargeBold" />
							<Attribute name="color" value="FFFFFFFF" />
						</AttributeSet>
						<AttributeSet name="ExitButton">
							<Attribute name="script" value="SecretAgents_Scripts_DroneScan:ConfirmQuit" />
						</AttributeSet>
					</Attribute>
				</AttributeSet>
				<AttributeSet name="touchables">
					<Attribute name="objects" value="HiddenAgent|SuperAgent" />
					<Attribute name="flagsToAvoid" value="delete" />
					<Attribute name="ignoreObjectTypes" value="flyby|building" />
					<Attribute name="runOnTouchScriptsInstantly" value="true" />
				</AttributeSet>
				<AttributeSet name="HideHud">
					<Attribute name="HideHud" value="true" />
				</AttributeSet>
				<AttributeSet name="onTouchStartedScripts">
					<Attribute name="HiddenAgent" value="SecretAgents_Scripts_DroneScan:AgentTouched" />
					<Attribute name="SuperAgent" value="SecretAgents_Scripts_DroneScan:SuperTouched" />
				</AttributeSet>
			</Attribute>
		</Action>
		<Action type="runScript" script="SecretAgents_Scripts_DroneScan:PostLaunchScript" />
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:DroneScanShader" />
		<Action type="toggleMonorail" stop="true" />
		<Action type="fadeScreen" colour="Black" direction="in" speed="1.0" />
	</PlayDroneGame>
	<PostLaunchScript parallel="true">
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:DeactivateMenuElements" />
	</PostLaunchScript>
	<DeactivateMenuElements parallel="true">
		<Action type="program">
			<Program><![CDATA[
if(DroneScan_Active)
{
	var menu = Menu::getID('eMenu_CustomTouch');
	var menuItems = Array::create('BaseBR',
		'BaseBL',
		'BaseTR',
		'BaseTL',
		'GridlineBR',
		'GridlineBL',
		'GridlineTR',
		'GridlineTL',
		'BaseTM',
		'BaseBM',
		'ScanlineEffectAnim01',
		'ScanlineEffectAnim02',
		'CenterAimAnim',
		'RandomTextAnim',
		'RandomGaugeRightAnim',
		'RandomGaugeLeftAnim',
		'Time01Anim',
		'Time02Anim',
		'TimeColonAnim',
		'Time03Anim',
		'Time04Anim');

var objectsID = StringID::fromString('Objects');

foreach(menuItems as item)
{
	Menu::Object::setVisible(menu,objectsID,item,true);
	Menu::Object::setActive(menu,objectsID,item,false);
}

Menu::Object::setVisible(menu,objectsID,'BattleIntroAnim',false);
Menu::Object::setActive(menu,objectsID,'BattleIntroAnim',false);

}
]]></Program>
		</Action>
	</DeactivateMenuElements>
	<AgentTouched parallel="true" cache="true">
		<Action type="if">
			<If expression="#fast; DS_PAUSED==0 &amp;&amp; DS_FRAMECNT&gt;0">
				<Then>
					<Action type="playflyby" flybyName="BlastEffect" radius="2" unitScale="0.13" playbackFPS="50" />
					<Action type="sound" sound="DroneScan_Agent_Tap" />
					<Action type="setObjectFlag" flags="delete" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_HiddenAgentsTapped" value="DroneScan_HiddenAgentsTapped+ 1" />
					<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:DeleteCharacter" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_JunkEarned" value="DroneScan_JunkEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:StandardJunk__'))" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_XPEarned" value="DroneScan_XPEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:StandardXP__'))" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_PTEarned" value="DroneScan_PTEarned+ toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:StandardPT__'))" />
				</Then>
			</If>
		</Action>
	</AgentTouched>
	<SuperTouched parallel="true" cache="true">
		<Action type="if">
			<If expression="#fast; DS_PAUSED==0 &amp;&amp; DS_FRAMECNT&gt;0">
				<Then>
					<Action type="playflyby" flybyName="BlastEffect" radius="2" unitScale="0.13" playbackFPS="50" />
					<Action type="sound" sound="DroneScan_SuperAgent_Tap" />
					<Action type="setObjectFlag" flags="delete" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_SuperAgentsTapped" value="DroneScan_SuperAgentsTapped+ 1" />
					<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:DeleteCharacter" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_JunkEarned" value="DroneScan_JunkEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:EliteJunk__'))" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_XPEarned" value="DroneScan_XPEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:EliteXP__'))" />
					<Action type="updateVariable" disableEvents="true" variable="DroneScan_PTEarned" value="DroneScan_PTEarned+ toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:ElitePT__'))" />
				</Then>
			</If>
		</Action>
	</SuperTouched>
	<DeleteCharacter parallel="true" cache="true" runQueueState="RunInAnyState">
		<Action type="setObjectFlag" flags="delete" />
		<Action type="runScript" script="SecretAgents_Scripts_DroneScan:FinishDeleteCharacter" />
	</DeleteCharacter>
	<FinishDeleteCharacter parallel="true" cache="true" runQueueState="RunInAnyState">
		<Action type="playCharacterEffect" waitUntilComplete="false" />
		<Action type="playCharacterAnimation" animation="Out" />
		<Action type="fade" fade="outmax" />
		<Action type="deletecharacter" />
	</FinishDeleteCharacter>
	<SpawnMore parallel="true" cache="true">
		<Action type="checkRequirements">
			<Requirement type="variable" variable="DroneScan_Active" />
			<True>
				<Action type="setVariable" intVariable="AgentType" intValue="rand(100)" disableEvents="true" addTempIfNotExisting="true" />
				<Action type="if">
					<If expression="AgentType &gt; (toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:EliteSpawnChance__'))*100)">
						<Then>
							<Action type="createobject" name="HiddenAgent" animation="in" count="1" save="false" panCamera="false" showFadeIn="false" building="SurveillancePost" awayFromSpawnLocMin="2" awayFromSpawnLocMax="30" preferPlayableArea="true" ignoreGrid="true" avoidRoadGridTypes="ocean|river|shoreline" enableCharacterOverlay="true" />
							<Action type="updateVariable" disableEvents="true" variable="DroneScan_HiddenAgentsSpawned" value="DroneScan_HiddenAgentsSpawned+ 1" />
						</Then>
					</If>
					<Else>
						<Then>
							<Action type="createobject" name="SuperAgent" animation="in" count="1" save="false" panCamera="false" showFadeIn="false" building="SurveillancePost" awayFromSpawnLocMin="2" awayFromSpawnLocMax="30" preferPlayableArea="true" ignoreGrid="true" avoidRoadGridTypes="ocean|river|shoreline" enableCharacterOverlay="true" />
							<Action type="updateVariable" disableEvents="true" variable="DroneScan_SuperAgentsSpawned" value="DroneScan_SuperAgentsSpawned+ 1" />
						</Then>
					</Else>
				</Action>
			</True>
		</Action>
	</SpawnMore>
	<RushDroneScanCooldown parallel="true">
		<Action type="checkRequirements">
			<Requirement type="formula" formula="System::evaluate('Minigame::DroneScan::Ready')==0" />
			<True>
				<Action type="sound" sound="UIButton" />
				<Action type="rushMinigame" minigame="DroneScan" />
			</True>
		</Action>
	</RushDroneScanCooldown>
	<DroneScanStart_Countdown ignoreHUD="true">
		<Action type="checkRequirements">
			<Requirement type="variable" variable="DroneScan_Active" />
			<True>
				<Action type="updateVariable" disableEvents="true" variable="DroneScan_Countdown" value="DroneScan_Countdown+1" />
				<Action type="checkExpression" expression="DroneScan_Countdown">
					<ExpressionCase value="1">
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="BattleIntroAnim">
									<Attribute name="image" value="ico_secretagents_battleintro" />
									<Attribute name="animation" value="Countdown_3" />
									<Attribute name="visible" value="true" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:DroneScanStart_Countdown" shouldSave="false" relativeTime="1s" />
						<Action type="delay" time="0.2" />
						<Action type="sound" sound="SciFighter_Countdown_Counter" />
					</ExpressionCase>
					<ExpressionCase value="2">
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="BattleIntroAnim">
									<Attribute name="image" value="ico_secretagents_battleintro" />
									<Attribute name="animation" value="Countdown_2" />
									<Attribute name="visible" value="true" />
									<Attribute name="looping" value="false" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:DroneScanStart_Countdown" shouldSave="false" relativeTime="1s" />
						<Action type="delay" time="0.2" />
						<Action type="sound" sound="SciFighter_Countdown_Counter" />
					</ExpressionCase>
					<ExpressionCase value="3">
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="BattleIntroAnim">
									<Attribute name="image" value="ico_secretagents_battleintro" />
									<Attribute name="animation" value="Countdown_1" />
									<Attribute name="visible" value="true" />
									<Attribute name="looping" value="false" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:DroneScanStart_Countdown" shouldSave="false" relativeTime="1s" />
						<Action type="delay" time="0.2" />
						<Action type="sound" sound="SciFighter_Countdown_Counter" />
					</ExpressionCase>
					<ExpressionCase value="4">
						<Action type="checkRequirements">
							<Requirement type="language" language="FRE_FR" />
							<False>
								<Action type="updateMenuItem" menu="eMenu_CustomTouch">
									<Attribute name="config">
										<AttributeSet name="BattleIntroAnim">
											<Attribute name="image" value="ico_secretagents_battleintro" />
											<Attribute name="animation" value="Countdown_0" />
											<Attribute name="visible" value="true" />
											<Attribute name="looping" value="false" />
										</AttributeSet>
									</Attribute>
								</Action>
							</False>
							<True>
								<Action type="updateMenuItem" menu="eMenu_CustomTouch">
									<Attribute name="config">
										<AttributeSet name="BattleIntroAnim">
											<Attribute name="image" value="ico_secretagents_battleintro" />
											<Attribute name="animation" value="Countdown_0_fr" />
											<Attribute name="visible" value="true" />
										</AttributeSet>
									</Attribute>
								</Action>
							</True>
						</Action>
						<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:DroneScanStart_Countdown" shouldSave="false" relativeTime="1s" />
						<Action type="runScript" script="SecretAgents_Scripts_DroneScan:Scroll_Begin" />
						<Action type="delay" time="0.2" />
						<Action type="sound" sound="SciFighter_Countdown_End" />
					</ExpressionCase>
					<ExpressionCase value="5">
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="BattleIntroAnim">
									<Attribute name="visible" value="false" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="Exitbutton">
									<Attribute name="visible" value="true" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="updateMenuItem" menu="eMenu_CustomTouch">
							<Attribute name="config">
								<AttributeSet name="ExitbuttonHL">
									<Attribute name="visible" value="true" />
								</AttributeSet>
							</Attribute>
						</Action>
						<Action type="updateVariable" disableEvents="true" variable="DS_PAUSED" value="0" />
						<Action type="runScript" script="SecretAgents_Scripts_DroneScan:UpdateTimer2" />
					</ExpressionCase>
				</Action>
			</True>
		</Action>
	</DroneScanStart_Countdown>
	<UpdateTimer2 ignoreHUD="true" cache="true">
		<Action type="if">
			<If expression="System::getGameState()=='GameState_CustomTouch'">
				<Then>
					<Action type="if">
						<If expression="DS_PAUSED==0">
							<Requirement type="variable" variable="DroneScan_Active" />
							<Then>
								<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:UpdateTimer_InState" />
								<Action type="if">
									<If expression="ISPANNING==0">
										<Then>
											<Action type="runScript" script="SecretAgents_Scripts_DroneScan:Scroll_Resume" />
										</Then>
									</If>
								</Action>
							</Then>
						</If>
					</Action>
					<Action type="scheduleScript" mode="replace" script="SecretAgents_Scripts_DroneScan:UpdateTimer2" shouldSave="false" relativeTime="1s" />
				</Then>
			</If>
		</Action>
	</UpdateTimer2>
	<UpdateTimer_InState cache="true" ignoreHUD="true">
		<Action type="if">
			<If expression="DS_PAUSED==0">
				<Then>
					<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:UpdateTimer_NotPaused" />
				</Then>
			</If>
		</Action>
	</UpdateTimer_InState>
	<UpdateTimer_NotPaused cache="true" ignoreHUD="true">
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:UpdateAnimatedTimer" />
		<Action type="if">
			<If expression="DS_FRAMECNT==0">
				<Then>
					<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:GameOver_Win" />
				</Then>
			</If>
			<Else>
				<Then>
					<Action type="program">
						<Program><![CDATA[
                                #program;
                                var x = toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:SpawnPerSec__'));
                                do
                                {
                                x = x-1;
                                Script::runImmediately('SecretAgents_Scripts_DroneScan:SpawnMore');
                                } while (x > 0);
                            ]]></Program>
					</Action>
				</Then>
			</Else>
		</Action>
		<Action type="updateVariable" disableEvents="true" variable="DS_FRAMECNT" value="DS_FRAMECNT-1" />
	</UpdateTimer_NotPaused>
	<UnloadCustomTouch parallel="true" ignoreHUD="true">
		<Action type="setShader" shader="" set="ShaderSets:InGameSet" />
		<Action type="runActionSequenceOnAll" character="HiddenAgent" script="SecretAgents_Scripts_DroneScan:DeleteCharacter" />
		<Action type="runActionSequenceOnAll" character="SuperAgent" script="SecretAgents_Scripts_DroneScan:DeleteCharacter" />
	</UnloadCustomTouch>
	<GameOver_Win>
		<Action type="interruptScript">
			<Interrupt package="SecretAgents_Scripts_DroneScan" script="Scroll_Begin">
				<InCategory category="any" />
			</Interrupt>
		</Action>
		<Action type="interruptScript">
			<Interrupt package="SecretAgents_Scripts_DroneScan" script="Scroll_Resume">
				<InCategory category="any" />
			</Interrupt>
		</Action>
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_JunkEarned" value="DroneScan_JunkEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:BaseJunk__'))" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_DevicesEarned" value="DroneScan_DevicesEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:BaseDevices__'))" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_XPEarned" value="DroneScan_XPEarned + toDouble(System::getConfigValue('__SecretAgents_GameConfig:DroneScan:BaseXP__'))" />
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:EndGame" />
	</GameOver_Win>
	<UpdateAnimatedTimer cache="true">
		<Action type="program">
			<Program><![CDATA[
				if(DS_FRAMECNT<5)Audio::playSingle('DCS_OpenWindow');

				var menu = Menu::getID('eMenu_CustomTouch');
				Menu::Animation::play(menu,'Objects','Time03Anim','timer_'+toString(floor(DS_FRAMECNT/10)),false);
				Menu::Animation::play(menu,'Objects','Time04Anim','timer_'+toString(mod(DS_FRAMECNT,10)),false);
				]]></Program>
		</Action>
	</UpdateAnimatedTimer>
	<GiveRewardAndShowPanel>
		<Action type="if">
			<If>
				<Requirement type="reqList" location="SecretAgents_Requirements:DroneScan_CanReceiveDevices" />
				<Then>
					<Action type="reward" SmartDevice="DroneScan_DevicesEarned" />
				</Then>
			</If>
		</Action>
		<Action type="if">
			<If>
				<Requirement type="reqList" location="SecretAgents_Requirements:DroneScan_CanReceiveJunk" />
				<Then>
					<Action type="reward" Junk="DroneScan_JunkEarned" />
				</Then>
			</If>
		</Action>
		<Action type="reward" xp="DroneScan_XPEarned" />
		<Action type="showMenu" menu="ChiliadRewardPanel" scriptResProvider="ChiliadRewardPanel.mns" menuConfig="SecretAgents_MenuConfig_DroneScan:DroneScanRewardMenuConfig" buttonsConfig="SecretAgents_MenuConfig_DroneScan:DroneScanRewardButtonConfig" />
		<Action type="actionSequence" script="SecretAgents_Scripts_DroneScan:FinishDroneScan" />
	</GiveRewardAndShowPanel>
	<DestroyAllTappables parallel="true">
		<Action type="if">
			<If>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActOne" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								Global::setVariable('SecretAgents_CraftingChance', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:DropChance_Craft1__'))*100);
								Global::setVariable('SecretAgents_CraftingCurrency', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:Award_Craft1__')));
							]]></Program>
					</Action>
				</Then>
			</If>
			<ElseIf>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActTwo" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								Global::setVariable('SecretAgents_CraftingChance', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:DropChance_Craft2__'))*100);
								Global::setVariable('SecretAgents_CraftingCurrency', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:Award_Craft2__')));
							]]></Program>
					</Action>
				</Then>
			</ElseIf>
			<ElseIf>
				<Requirements>
					<Requirement type="reqList" location="SecretAgents_Requirements:ActThree" />
				</Requirements>
				<Then>
					<Action type="program">
						<Program><![CDATA[
								#program;
								Global::setVariable('SecretAgents_CraftingChance', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:DropChance_Craft3__'))*100);
								Global::setVariable('SecretAgents_CraftingCurrency', toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:Award_Craft3__')));
							]]></Program>
					</Action>
				</Then>
			</ElseIf>
		</Action>
		<Action type="program">
			<Program><![CDATA[#program;

					var character = Character::find('ManInTan');
					var characterInstanceList = Land::getAllInstancesOfObject(character);

					var eventCurrencyPerGuy = toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:Tappables:Award_PTCurrency__'));
					var craftingChance = Global::getVariable('SecretAgents_CraftingChance');
					var craftingCurrencyPerGuy = Global::getVariable('SecretAgents_CraftingCurrency');

					var eventCurrencyTotal = 0;
					var craftingCurrencyTotal = 0;
					var guysTapped = 0;

					foreach(characterInstanceList as instance)
					{
						if (Object::getDelete(instance)!=1)
						{
							eventCurrencyTotal += eventCurrencyPerGuy;
							if (rand(100) <= craftingChance)
							{
								craftingCurrencyTotal += craftingCurrencyPerGuy;
							}
							guysTapped++;

							Object::setDelete(instance, true);
							Character::stopMovement(instance);
							Script::runOnObjectInstance('SecretAgents_Scripts:ManInTan_AnimateAndKill', instance);
						}
					}
					var bankedMIT = User::getVariable('BankedManInTan');
					while (bankedMIT > 0)
					{
						bankedMIT -= 1;
						eventCurrencyTotal += eventCurrencyPerGuy;
						guysTapped++;
						if (rand(100) <= craftingChance)
						{
							craftingCurrencyTotal += craftingCurrencyPerGuy;
						}
					}

					Global::setVariable('SecretAgents_TappablePTCurrency', eventCurrencyTotal);
					Global::setVariable('SecretAgents_TappableCraftCurrency', craftingCurrencyTotal);
					Global::setVariable('SecretAgents_DroneTapped', guysTapped);
					User::setVariable('BankedManInTan', 0, true);

					User::setVariable('SecretAgents_TappablesTapped', User::getVariable('SecretAgents_TappablesTapped') + guysTapped, true);
				]]></Program>
		</Action>
		<Action type="checkRequirements">
			<Requirements>
				<Requirement type="active quest" quest="SecretAgents_DCS_ManInTan" />
			</Requirements>
			<True>
				<Action type="updateVariable" variable="DCS_MIT" value="DCS_MIT + Global::getVariable('SecretAgents_DroneTapped')" />
			</True>
		</Action>
		<Action type="runActionSequenceOnAll" character="ManInTan" script="SciFi_Scripts_Tappables:SetRobotsToDelete" />
		<Action type="reward" save="true" SecretAgents_ActivePrizeTrackCurrency="Global::getVariable('SecretAgents_TappablePTCurrency')" SecretAgents_Schematics="Global::getVariable('SecretAgents_TappableCraftCurrency')" suppress_sound="true" />
	</DestroyAllTappables>
	<CleanUp>
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_PTEarned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_JunkEarned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_DevicesEarned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_XPEarned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_HiddenAgentsTapped" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_SuperAgentsTapped" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_HiddenAgentsSpawned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_SuperAgentsSpawned" value="0" />
		<Action type="updateVariable" disableEvents="true" variable="DroneScan_Countdown" value="0" />
	</CleanUp>
	<FinishDroneScan parallel="true">
		<Action type="setMiniGameState" building="SurveillancePost" name="DroneScan" state="Ready" />
		<Action type="stopSoundKit" sound="DroneScan_Ambience_Loop" fadeoutTime="1.5" />
		<Action type="program">
			<Program><![CDATA[
                    #program;
                    var DNAArray = Array::create('specialevent'=>173000, 'ids'=>Array::create(3373));
                    var returnArray = DNA::GetSpecialEventEvents(DNAArray);
                    var eventArray = Array::getValueForKey(returnArray, 3373);
                    var param1Array = Array::getValueForKey(eventArray, 'param1');
                    var param3Array = Array::getValueForKey(eventArray, 'param3');
                    var ptEarned = Array::getValueForKey(param1Array, 'extra');
                    var timesPlayed = Array::getValueForKey(param3Array, 'extra');
                    var expectedAverage = toDouble(System::getConfigValue('__SecretAgents_Spreadsheet_Config:DroneScan:Scan_AverageValue__'));

                    if ((ptEarned/timesPlayed) > (expectedAverage * 0.70))
                    {
                        User::setVariable('DroneScan_PlayerSkill', 0, true);
                    }
                    elseif ((ptEarned/timesPlayed) < (expectedAverage * 0.50))
                    {
                        User::setVariable('DroneScan_PlayerSkill', 2, true);
                    }
                    else
                    {
                        User::setVariable('DroneScan_PlayerSkill', 1, true);
                    }

                ]]></Program>
		</Action>
	</FinishDroneScan>
</ScriptPackage>
